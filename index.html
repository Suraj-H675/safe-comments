<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SafeComment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            accent: '#ffffff',
            accentHover: '#d4d4d4',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      background: #000000;
    }

    /* Subtle ambient glow */
    body::before {
      content: '';
      position: fixed;
      width: 600px; height: 600px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%);
      top: -200px; left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
      z-index: 0;
    }

    /* Glassmorphism on black */
    .glass {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }
    .glass-strong {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .glass-subtle {
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
    .glass-input {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .glass-input:focus {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

    /* Toast animation */
    @keyframes toastIn  { from { opacity: 0; transform: translateX(60px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(60px); } }
    .toast-in  { animation: toastIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards; }
    .toast-out { animation: toastOut 0.25s ease-in forwards; }

    /* Buttons */
    .btn-action {
      transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
    }
    .btn-action:hover {
      transform: translateY(-1px);
    }
    .btn-action:active {
      transform: scale(0.96);
    }

    /* Like button active (pink glow) */
    .like-active {
      color: #f472b6 !important;
      filter: drop-shadow(0 0 6px rgba(244, 114, 182, 0.4));
    }
    .like-active:hover {
      filter: drop-shadow(0 0 10px rgba(244, 114, 182, 0.5));
    }

    /* Dislike button active (red glow) */
    .dislike-active {
      color: #f87171 !important;
      filter: drop-shadow(0 0 6px rgba(248, 113, 113, 0.4));
    }
    .dislike-active:hover {
      filter: drop-shadow(0 0 10px rgba(248, 113, 113, 0.5));
    }

    /* Pop animation on vote */
    @keyframes votePop {
      0%   { transform: scale(1); }
      40%  { transform: scale(1.25); }
      100% { transform: scale(1); }
    }
    .vote-pop {
      animation: votePop 0.35s cubic-bezier(0.16,1,0.3,1);
    }

    /* Translated box */
    .translated-box {
      border-left: 2px solid rgba(255, 255, 255, 0.2);
    }

    /* Inner glow on cards */
    .card-glow {
      box-shadow: inset 0 1px 0 0 rgba(255,255,255,0.04), 0 2px 16px -4px rgba(0,0,0,0.5);
      transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
    }
    .card-glow:hover {
      box-shadow: inset 0 1px 0 0 rgba(255,255,255,0.06), 0 4px 24px -4px rgba(0,0,0,0.6);
      border-color: rgba(255,255,255,0.1);
    }

    /* Select dropdown */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%234b5563' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }

    /* Shimmer line */
    .shimmer-line {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
      background-size: 200% 100%;
      animation: shimmer 4s linear infinite;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Fly-in ghost bubble */
    .fly-ghost {
      position: fixed;
      z-index: 100;
      pointer-events: none;
      transition: none;
    }

    /* Strong glow on latest comment */
    @keyframes latestGlow {
      0%, 100% { box-shadow: inset 0 1px 0 0 rgba(255,255,255,0.08), 0 0 34px 6px rgba(255,255,255,0.08); }
      50%      { box-shadow: inset 0 1px 0 0 rgba(255,255,255,0.12), 0 0 46px 10px rgba(255,255,255,0.12); }
    }
    .latest-comment {
      border-color: rgba(255,255,255,0.2) !important;
      animation: latestGlow 2.2s ease-in-out infinite;
    }

    /* Dynamic grid layout â€” strict max 4 columns */
    .comment-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
      transition: all 0.3s ease;
      align-items: stretch;
    }
    .comment-grid.cols-1 {
      grid-template-columns: 1fr;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }
    .comment-grid.cols-2 {
      grid-template-columns: repeat(2, 50%);
      width: 100vw;
      max-width: 100vw;
      margin-left: calc(50% - 50vw);
      gap: 0;
    }
    .comment-grid.cols-3 {
      grid-template-columns: repeat(3, 33.333333%);
      width: 100vw;
      max-width: 100vw;
      margin-left: calc(50% - 50vw);
      gap: 0;
    }
    .comment-grid.cols-4 {
      grid-template-columns: repeat(4, 25%);
      width: 100vw;
      max-width: 100vw;
      margin-left: calc(50% - 50vw);
      gap: 0;
    }
    @media (max-width: 680px) {
      .comment-grid.cols-3 { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .comment-grid.cols-3,
      .comment-grid.cols-2 { grid-template-columns: 1fr; max-width: 100%; }
    }

    .comment-grid > div {
      margin: 6px;
    }

    /* Context menus */
    .context-menu {
      background: rgba(14, 14, 14, 0.92);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
    }
    .menu-dot {
      line-height: 1;
      letter-spacing: 1px;
    }

    /* Inline editor */
    .inline-editor {
      caret-color: #ffffff;
      cursor: text;
      outline: none;
    }
    .inline-editor:focus {
      outline: none;
    }

    /* Input bar focus */
    input:focus { outline: none; }

    * { position: relative; z-index: 1; }
    body::before { position: fixed; z-index: 0; }
  </style>
</head>
<body class="text-gray-300 font-sans min-h-screen flex flex-col">

  <!-- ===== Toast Container ===== -->
  <div id="toastContainer" class="fixed top-5 right-5 z-50 flex flex-col gap-3 max-w-sm"></div>

  <!-- ===== Header ===== -->
  <header class="glass-strong sticky top-0 z-40 border-b border-white/[0.04]">
    <div class="max-w-3xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-white/[0.06] flex items-center justify-center border border-white/[0.06]">
          <span class="text-base">ðŸ’¬</span>
        </div>
        <div>
          <h1 class="text-base font-semibold text-white leading-tight tracking-tight">SafeComment</h1>
          <p class="text-[10px] text-gray-600 tracking-widest uppercase">Safe Space</p>
        </div>
      </div>
      <div class="text-[10px] text-gray-600 tracking-wider uppercase">Comments</div>
    </div>
  </header>

  <!-- ===== Main Content ===== -->
  <main class="flex-1 w-full mx-auto px-6 pt-6 pb-28 space-y-5">

    <!-- City banner -->
    <div id="cityBanner" class="flex items-center gap-2 text-xs text-gray-600">
      <span class="inline-block w-1.5 h-1.5 rounded-full bg-white/30 animate-pulse"></span>
      <span id="cityText">Detecting your locationâ€¦</span>
    </div>

    <!-- ===== Comment Count ===== -->
    <div class="flex items-center justify-between gap-4">
      <h3 id="commentCount" class="text-xs font-medium text-gray-600 whitespace-nowrap uppercase tracking-wider">0 Comments</h3>
      <div class="h-px flex-1 shimmer-line rounded-full"></div>
    </div>

    <!-- ===== Comments List ===== -->
    <section id="commentsList" class="comment-grid cols-1"></section>

  </main>

  <!-- ===== Bottom Input Bar ===== -->
  <div id="inputBar" class="fixed bottom-0 left-0 right-0 z-40 border-t border-white/[0.04]" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
      <input id="commentInput" type="text" maxlength="500"
        placeholder="Say somethingâ€¦"
        class="flex-1 glass-input rounded-full px-5 py-3 text-sm text-gray-200 placeholder-gray-600 transition-all duration-200" />
      <button id="sendBtn"
        class="btn-action w-10 h-10 rounded-full bg-white/[0.08] hover:bg-white/[0.14] border border-white/[0.08] flex items-center justify-center transition-all"
        aria-label="Send">
        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- ===== Language Context Menu ===== -->
  <div id="langMenu" class="fixed z-50 hidden context-menu rounded-xl p-3 w-[340px]">
    <div class="text-xs text-gray-400 mb-2">Translate to</div>
    <input id="langSearch" type="text" placeholder="Search language..."
      class="w-full glass-input rounded-lg px-3 py-2 text-sm text-gray-200 placeholder-gray-600 mb-2" />
    <div id="langList" class="max-h-72 overflow-y-auto space-y-1 pr-1"></div>
  </div>

  <!-- ===== JavaScript ===== -->
  <script>
    /* =========================================================
       CONSTANTS & STATE
       ========================================================= */
    const STORAGE_KEY   = 'safecomments_data';
    const LANG_KEY      = 'safecomments_lang';
    const CITY_KEY      = 'safecomments_city';
    const VOTES_KEY     = 'safecomments_votes';
    const USER_KEY      = 'safecomments_user_id';
    const VIRTUALIZATION_THRESHOLD = 120;
    const VIRTUAL_ROW_HEIGHT = 290;
    const VIRTUAL_BUFFER_ROWS = 2;
    // Block ALL special characters â€” only letters (any script), digits, spaces, and common punctuation allowed
    // Allowed: letters, numbers, spaces, . , ! ? : ; ' " - ( ) newlines
    const ALLOWED_RE    = /^[\p{L}\p{N}\s.,!?;:'"()\-\n\r]+$/u;
    const MAX_CHARS     = 500;

    // Language display names & ISO codes
    const LANG_NAMES = {
      en: 'English', hi: 'Hindi', bn: 'Bengali', te: 'Telugu', mr: 'Marathi',
      ta: 'Tamil', ur: 'Urdu', gu: 'Gujarati', kn: 'Kannada', ml: 'Malayalam',
      pa: 'Punjabi', or: 'Odia', as: 'Assamese', ne: 'Nepali', sa: 'Sanskrit',
      sd: 'Sindhi', es: 'Spanish', fr: 'French', de: 'German', ar: 'Arabic',
      zh: 'Chinese', ru: 'Russian', ja: 'Japanese', ko: 'Korean', pt: 'Portuguese'
    };

    const LANGUAGES = [
      { code: 'hi', name: 'Hindi' },
      { code: 'bn', name: 'Bengali' },
      { code: 'te', name: 'Telugu' },
      { code: 'mr', name: 'Marathi' },
      { code: 'ta', name: 'Tamil' },
      { code: 'ur', name: 'Urdu' },
      { code: 'gu', name: 'Gujarati' },
      { code: 'kn', name: 'Kannada' },
      { code: 'ml', name: 'Malayalam' },
      { code: 'pa', name: 'Punjabi' },
      { code: 'or', name: 'Odia' },
      { code: 'as', name: 'Assamese' },
      { code: 'ne', name: 'Nepali' },
      { code: 'sa', name: 'Sanskrit' },
      { code: 'sd', name: 'Sindhi' },
      { code: 'en', name: 'English' },
      { code: 'es', name: 'Spanish' },
      { code: 'fr', name: 'French' },
      { code: 'de', name: 'German' },
      { code: 'ar', name: 'Arabic' },
      { code: 'zh', name: 'Chinese' },
      { code: 'ru', name: 'Russian' },
      { code: 'ja', name: 'Japanese' },
      { code: 'ko', name: 'Korean' },
      { code: 'pt', name: 'Portuguese' },
    ];

    // 4 seed comments
    const SEED_COMMENTS = [
      { id: 1, text: 'This is such a welcoming and inclusive space! Love the multilingual support.', lang: 'en', city: 'San Francisco', timestamp: Date.now() - 3600000, likes: 4, dislikes: 0 },
      { id: 2, text: 'à¤¯à¤¹ à¤ªà¥à¤²à¥‡à¤Ÿà¤«à¤¼à¥‰à¤°à¥à¤® à¤¬à¤¹à¥à¤¤ à¤…à¤šà¥à¤›à¤¾ à¤¹à¥ˆà¥¤ à¤¹à¤° à¤­à¤¾à¤·à¤¾ à¤®à¥‡à¤‚ à¤Ÿà¤¿à¤ªà¥à¤ªà¤£à¥€ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚!', lang: 'hi', city: 'Mumbai', timestamp: Date.now() - 7200000, likes: 3, dislikes: 0 },
      { id: 3, text: 'Me encanta esta seccion de comentarios! Es muy segura y facil de usar.', lang: 'es', city: 'Madrid', timestamp: Date.now() - 10800000, likes: 5, dislikes: 0 },
      { id: 4, text: 'Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø±Ø§Ø¦Ø¹ ÙˆÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª. Ø´ÙƒØ±Ø§ Ù„ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ø¢Ù…Ù†Ø©!', lang: 'ar', city: 'Dubai', timestamp: Date.now() - 14400000, likes: 2, dislikes: 0 },
    ];

    let userCity = localStorage.getItem(CITY_KEY) || '';

    /* =========================================================
       LANGUAGE DETECTION (simple heuristic)
       ========================================================= */
    function detectLanguage(text) {
      // Check Unicode script ranges
      if (/[\u0900-\u097F]/.test(text)) return 'hi';        // Devanagari â†’ Hindi
      if (/[\u0B80-\u0BFF]/.test(text)) return 'ta';        // Tamil
      if (/[\u0600-\u06FF]/.test(text)) return 'ar';        // Arabic
      if (/[\u4E00-\u9FFF]/.test(text)) return 'zh';        // Chinese
      if (/[\u0400-\u04FF]/.test(text)) return 'ru';        // Cyrillic â†’ Russian
      // Latin-script detection by common words
      const lower = text.toLowerCase();
      if (/\b(el|los|las|una|esta|muy|es|por|como|que)\b/.test(lower)) return 'es';
      if (/\b(le|la|les|des|une|est|pour|avec|dans|je|tu|il)\b/.test(lower)) return 'fr';
      if (/\b(der|die|das|und|ist|ein|eine|nicht|mit|auf)\b/.test(lower)) return 'de';
      return 'en';
    }

    /* =========================================================
       DOM REFERENCES
       ========================================================= */
    const $commentInput  = document.getElementById('commentInput');
    const $sendBtn       = document.getElementById('sendBtn');
    const $commentsList  = document.getElementById('commentsList');
    const $commentCount  = document.getElementById('commentCount');
    const $cityText      = document.getElementById('cityText');
    const $toastContainer = document.getElementById('toastContainer');
    const $langMenu      = document.getElementById('langMenu');
    const $langSearch    = document.getElementById('langSearch');
    const $langList      = document.getElementById('langList');

    let pendingTranslate = null;
    let editingCommentId = null;
    let editDraftText = '';
    let virtualRenderRaf = null;
    let currentUserId = localStorage.getItem(USER_KEY) || '';
    if (!currentUserId) {
      currentUserId = `u_${Math.random().toString(36).slice(2, 10)}`;
      localStorage.setItem(USER_KEY, currentUserId);
    }

    /* =========================================================
       TOAST NOTIFICATIONS
       ========================================================= */
    function showToast(message, type = 'info', options = {}) {
      const colors = {
        error:   'bg-white/[0.06] border-red-500/20 text-red-400',
        success: 'bg-white/[0.06] border-white/10 text-gray-300',
        info:    'bg-white/[0.04] border-white/[0.06] text-gray-400',
        warn:    'bg-white/[0.06] border-yellow-500/20 text-yellow-400',
      };
      const toast = document.createElement('div');
      toast.className = `toast-in ${colors[type] || colors.info} border rounded-xl px-4 py-3 text-xs shadow-2xl shadow-black/40`;
      toast.style.cssText = 'backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);';

      const row = document.createElement('div');
      row.className = 'flex items-center gap-3';

      const text = document.createElement('span');
      text.textContent = message;
      row.appendChild(text);

      if (options.actionLabel && typeof options.onAction === 'function') {
        const actionBtn = document.createElement('button');
        actionBtn.className = 'text-xs text-white underline underline-offset-2 hover:text-gray-200 transition-colors';
        actionBtn.textContent = options.actionLabel;
        actionBtn.onclick = (e) => {
          e.stopPropagation();
          options.onAction();
          toast.remove();
        };
        row.appendChild(actionBtn);
      }

      toast.appendChild(row);
      $toastContainer.appendChild(toast);
      const duration = Number.isFinite(options.duration) ? options.duration : 3000;
      setTimeout(() => {
        toast.classList.remove('toast-in');
        toast.classList.add('toast-out');
        toast.addEventListener('animationend', () => toast.remove());
      }, duration);
    }

    /* =========================================================
       LOCAL-STORAGE HELPERS
       ========================================================= */
    function loadComments() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function saveComments(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    /** Vote tracking: { commentId: 'like' | 'dislike' } */
    function loadVotes() {
      try {
        const raw = localStorage.getItem(VOTES_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function saveVotes(obj) {
      localStorage.setItem(VOTES_KEY, JSON.stringify(obj));
    }

    function getPreferredLang() {
      return localStorage.getItem(LANG_KEY) || 'en';
    }

    function setPreferredLang(lang) {
      localStorage.setItem(LANG_KEY, lang);
    }

    /* =========================================================
       RELATIVE TIME
       ========================================================= */
    function relativeTime(ts) {
      const diff = Math.floor((Date.now() - ts) / 1000);
      if (diff < 10)    return 'just now';
      if (diff < 60)    return `${diff}s ago`;
      if (diff < 3600)  return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      if (diff < 172800) return 'Yesterday';
      return new Date(ts).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    }

    /* =========================================================
       VALIDATION
       ========================================================= */
    function validateComment(text) {
      if (!text.trim()) return { valid: false, reason: 'empty' };
      if (!ALLOWED_RE.test(text)) return { valid: false, reason: 'special' };
      return { valid: true };
    }

    /* =========================================================
       RENDER COMMENTS (newest first)
       ========================================================= */
    function getColumnCountForComments(count) {
      if (count <= 1) return 1;
      if (count <= 3) return 2;
      if (count <= 6) return 3;
      return 4;
    }

    function appendCommentCard(c, latestId, newId) {
      const isLatest = c.id === latestId && c.id !== newId;
      const card = document.createElement('div');
      card.className = `glass rounded-2xl p-4 flex flex-col card-glow${isLatest ? ' latest-comment' : ''}`;
      card.id = `comment-${c.id}`;

      if (c.id === newId) {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.95)';
      }

      const header = document.createElement('div');
      header.className = 'flex items-center justify-between text-[11px] text-gray-600';

      const leftMeta = document.createElement('span');
      leftMeta.className = 'flex items-center gap-1.5';
      leftMeta.innerHTML = `<svg class="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>${escapeHTML(c.city)}`;

      const rightMeta = document.createElement('div');
      rightMeta.className = 'flex items-center gap-2';

      const timeGroup = document.createElement('div');
      timeGroup.className = 'flex items-center gap-1.5';
      const timeEl = document.createElement('span');
      timeEl.textContent = relativeTime(c.timestamp);
      timeGroup.appendChild(timeEl);
      if (c.editedAt) {
        const editedEl = document.createElement('span');
        editedEl.className = 'text-[10px] text-gray-300 border border-white/10 rounded px-1.5 py-0.5';
        editedEl.textContent = 'Edited';
        timeGroup.appendChild(editedEl);
      }
      rightMeta.appendChild(timeGroup);

      if (!c.authorId || c.authorId === currentUserId) {
        const menuWrap = document.createElement('div');
        menuWrap.className = 'relative';

        const menuBtn = document.createElement('button');
        menuBtn.className = 'btn-action text-gray-500 hover:text-gray-300 text-base px-1 menu-dot';
        menuBtn.textContent = 'â‹¯';
        menuBtn.onclick = (e) => {
          e.stopPropagation();
          toggleCommentMenu(c.id);
        };

        const menu = document.createElement('div');
        menu.id = `menu-${c.id}`;
        menu.className = 'hidden absolute right-0 bottom-full mb-1 context-menu rounded-lg p-1 min-w-[120px] z-40';
        menu.innerHTML = `
          <button class="w-full text-left px-2.5 py-1.5 text-xs text-gray-300 hover:text-white hover:bg-white/[0.06] rounded" data-action="edit">Edit</button>
          <button class="w-full text-left px-2.5 py-1.5 text-xs text-red-400 hover:text-red-300 hover:bg-white/[0.06] rounded" data-action="delete">Delete</button>`;
        menu.addEventListener('click', (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          const action = target.dataset.action;
          if (action === 'edit') editComment(c.id);
          if (action === 'delete') deleteComment(c.id);
        });

        menuWrap.append(menuBtn, menu);
        rightMeta.appendChild(menuWrap);
      }

      header.append(leftMeta, rightMeta);
      card.appendChild(header);

      const textEl = document.createElement('p');
      textEl.className = 'text-gray-200 text-sm leading-relaxed whitespace-pre-wrap break-words flex-1 mt-2';
      textEl.id = `text-${c.id}`;
      textEl.textContent = editingCommentId === c.id ? editDraftText : c.text;

      if (editingCommentId === c.id) {
        textEl.setAttribute('contenteditable', 'true');
        textEl.setAttribute('tabindex', '0');
        textEl.spellcheck = true;
        textEl.className += ' inline-editor';
        textEl.addEventListener('input', () => {
          const value = textEl.textContent || '';
          if (value.length > MAX_CHARS) {
            textEl.textContent = value.slice(0, MAX_CHARS);
          }
          editDraftText = textEl.textContent || '';
        });
        textEl.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            saveInlineEdit(c.id);
          }
          if (e.key === 'Escape') {
            e.preventDefault();
            cancelInlineEdit();
          }
        });
      }
      card.appendChild(textEl);

      const transBox = document.createElement('div');
      transBox.id = `trans-${c.id}`;
      transBox.className = 'hidden';
      card.appendChild(transBox);

      const actions = document.createElement('div');
      actions.className = 'flex items-center gap-2 pt-2 mt-auto';

      if (editingCommentId === c.id) {
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn-action text-xs px-3 py-1.5 text-gray-500 hover:text-gray-300 ml-auto';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = cancelInlineEdit;

        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn-action text-xs px-3 py-1.5 text-white bg-white/[0.08] hover:bg-white/[0.14] rounded-lg border border-white/[0.08]';
        saveBtn.textContent = 'Save';
        saveBtn.onclick = () => saveInlineEdit(c.id);

        actions.append(cancelBtn, saveBtn);
      } else {
        const votes = loadVotes();
        const userVote = votes[c.id];

        const likeBtn = document.createElement('button');
        likeBtn.className = `btn-action flex items-center gap-1 text-[11px] px-2 py-1 transition-all ${userVote === 'like' ? 'like-active' : 'text-gray-500 hover:text-pink-400'}`;
        likeBtn.innerHTML = `<span>&#9829;</span> <span>${c.likes}</span>`;
        likeBtn.onclick = () => handleLike(c.id);

        const dislikeBtn = document.createElement('button');
        dislikeBtn.className = `btn-action flex items-center gap-1 text-[11px] px-2 py-1 transition-all ${userVote === 'dislike' ? 'dislike-active' : 'text-gray-500 hover:text-red-400'}`;
        dislikeBtn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M6 13l6 6 6-6"/></svg> <span>${c.dislikes}</span>`;
        dislikeBtn.onclick = () => handleDislike(c.id);

        const translateBtn = document.createElement('button');
        translateBtn.className = 'btn-action flex items-center gap-1 text-[11px] px-2 py-1 text-gray-500 hover:text-gray-300 transition-all ml-auto';
        translateBtn.textContent = 'Translate';
        translateBtn.onclick = (e) => {
          e.stopPropagation();
          openLanguageDialog(c.id, c.text, c.lang, e.currentTarget);
        };

        actions.append(likeBtn, dislikeBtn, translateBtn);
      }
      card.appendChild(actions);

      $commentsList.appendChild(card);

      if (editingCommentId === c.id) {
        requestAnimationFrame(() => focusInlineEditor(c.id));
      }
    }

    function focusInlineEditor(id) {
      const input = document.getElementById(`text-${id}`);
      if (!input) return;
      input.focus();
      const selection = window.getSelection();
      if (!selection) return;
      const range = document.createRange();
      range.selectNodeContents(input);
      range.collapse(false);
      selection.removeAllRanges();
      selection.addRange(range);
    }

    function renderComments(newId = null) {
      const comments = loadComments() || [];
      const sorted = [...comments].sort((a, b) => b.timestamp - a.timestamp);
      const latestId = sorted.length > 0 ? sorted[0].id : null;

      $commentCount.textContent = `${sorted.length} Comment${sorted.length !== 1 ? 's' : ''}`;
      $commentsList.innerHTML = '';

      $commentsList.classList.remove('cols-1', 'cols-2', 'cols-3', 'cols-4');
      const count = sorted.length;
      const columns = getColumnCountForComments(count);
      $commentsList.classList.add(`cols-${columns}`);

      if (count > VIRTUALIZATION_THRESHOLD) {
        const listTop = $commentsList.getBoundingClientRect().top + window.scrollY;
        const viewportTop = Math.max(0, window.scrollY - listTop);
        const viewportRows = Math.ceil((window.innerHeight + VIRTUAL_ROW_HEIGHT * VIRTUAL_BUFFER_ROWS * 2) / VIRTUAL_ROW_HEIGHT);
        const startRow = Math.max(0, Math.floor(viewportTop / VIRTUAL_ROW_HEIGHT) - VIRTUAL_BUFFER_ROWS);
        const totalRows = Math.ceil(count / columns);
        const endRow = Math.min(totalRows, startRow + viewportRows);
        const startIndex = startRow * columns;
        const endIndex = Math.min(count, endRow * columns);

        const topSpacer = document.createElement('div');
        topSpacer.style.gridColumn = '1 / -1';
        topSpacer.style.height = `${startRow * VIRTUAL_ROW_HEIGHT}px`;
        $commentsList.appendChild(topSpacer);

        sorted.slice(startIndex, endIndex).forEach((c) => appendCommentCard(c, latestId, newId));

        const bottomSpacer = document.createElement('div');
        bottomSpacer.style.gridColumn = '1 / -1';
        bottomSpacer.style.height = `${Math.max(0, (totalRows - endRow) * VIRTUAL_ROW_HEIGHT)}px`;
        $commentsList.appendChild(bottomSpacer);
        return;
      }

      sorted.forEach((c) => appendCommentCard(c, latestId, newId));
    }

    /* =========================================================
       FLY-TO ANIMATION
       ========================================================= */
    function animateFlyTo(text, commentId) {
      const inputRect = $commentInput.getBoundingClientRect();

      // Create ghost bubble at the input bar position
      const ghost = document.createElement('div');
      ghost.className = 'fly-ghost glass rounded-2xl p-4';
      ghost.style.cssText = `
        left: ${inputRect.left}px;
        top: ${inputRect.top}px;
        width: ${inputRect.width}px;
        opacity: 1;
        font-size: 14px;
        color: #e5e7eb;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: ${inputRect.width}px;
      `;
      ghost.textContent = text;
      document.body.appendChild(ghost);

      // Wait a frame, then render comments (with new one invisible)
      requestAnimationFrame(() => {
        renderComments(commentId);

        // Find target card
        const targetCard = document.getElementById(`comment-${commentId}`);
        if (!targetCard) {
          ghost.remove();
          return;
        }

        const targetRect = targetCard.getBoundingClientRect();

        // Animate ghost from input â†’ target card position
        ghost.style.transition = 'all 0.55s cubic-bezier(0.22, 1, 0.36, 1)';

        requestAnimationFrame(() => {
          ghost.style.left = `${targetRect.left}px`;
          ghost.style.top = `${targetRect.top}px`;
          ghost.style.width = `${targetRect.width}px`;
          ghost.style.opacity = '0.6';
        });

        // After fly animation ends, reveal the real card and apply latest glow
        setTimeout(() => {
          ghost.remove();
          targetCard.style.transition = 'opacity 0.3s, transform 0.3s';
          targetCard.style.opacity = '1';
          targetCard.style.transform = 'scale(1)';
          targetCard.classList.add('latest-comment');
          document.querySelectorAll('.latest-comment').forEach(el => {
            if (el.id !== `comment-${commentId}`) el.classList.remove('latest-comment');
          });
        }, 560);
      });
    }

    function closeAllCommentMenus() {
      document.querySelectorAll('[id^="menu-"]').forEach((menu) => menu.classList.add('hidden'));
    }

    function toggleCommentMenu(id) {
      const menu = document.getElementById(`menu-${id}`);
      if (!menu) return;
      const willOpen = menu.classList.contains('hidden');
      closeAllCommentMenus();
      if (willOpen) menu.classList.remove('hidden');
    }

    function renderLanguageOptions(query = '') {
      const q = query.trim().toLowerCase();
      const filtered = LANGUAGES.filter((lang) =>
        !q || lang.name.toLowerCase().includes(q) || lang.code.toLowerCase().includes(q)
      );
      $langList.innerHTML = '';

      filtered.forEach((lang) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-full text-left px-2 py-1.5 text-sm text-gray-300 hover:text-white transition-colors';
        btn.innerHTML = `<span class="font-medium">${lang.name}</span> <span class="text-xs text-gray-500 ml-2 uppercase">${lang.code}</span>`;
        btn.onclick = () => {
          if (!pendingTranslate) return;
          setPreferredLang(lang.code);
          closeLanguageDialog();
          performTranslation(pendingTranslate.id, pendingTranslate.originalText, pendingTranslate.sourceLang, lang.code);
        };
        $langList.appendChild(btn);
      });

      if (filtered.length === 0) {
        $langList.innerHTML = '<p class="text-xs text-gray-500 px-2 py-2">No matching language found.</p>';
      }
    }

    function positionLanguageMenu(anchorEl) {
      const rect = anchorEl.getBoundingClientRect();
      const menuWidth = 340;
      const margin = 12;

      const left = Math.max(margin, Math.min(rect.left, window.innerWidth - menuWidth - margin));
      $langMenu.style.left = `${left}px`;

      // place below by default; if it overflows, place above; always clamp inside viewport
      const estimatedTop = rect.bottom + 8;
      $langMenu.style.top = `${estimatedTop}px`;

      const menuHeight = $langMenu.offsetHeight || 320;
      let top = estimatedTop;

      if (top + menuHeight > window.innerHeight - margin) {
        top = rect.top - menuHeight - 8;
      }
      top = Math.max(margin, Math.min(top, window.innerHeight - menuHeight - margin));
      $langMenu.style.top = `${top}px`;
    }

    function openLanguageDialog(id, originalText, sourceLang, anchorEl) {
      pendingTranslate = { id, originalText, sourceLang };
      closeAllCommentMenus();
      $langMenu.classList.remove('hidden');
      $langSearch.value = '';
      renderLanguageOptions('');

      // wait one frame for accurate menu height, then clamp into viewport
      requestAnimationFrame(() => positionLanguageMenu(anchorEl));

      setTimeout(() => $langSearch.focus(), 0);
    }

    function closeLanguageDialog() {
      $langMenu.classList.add('hidden');
    }

    function scheduleVirtualizedRender() {
      if (virtualRenderRaf) return;
      virtualRenderRaf = requestAnimationFrame(() => {
        virtualRenderRaf = null;
        const count = (loadComments() || []).length;
        if (count > VIRTUALIZATION_THRESHOLD) {
          renderComments();
        }
      });
    }

    /* =========================================================
       ACTIONS
       ========================================================= */

    function handleLike(id) {
      const votes = loadVotes();
      if (votes[id] === 'like') {
        showToast('You already liked this.', 'info');
        return;
      }
      const comments = loadComments() || [];
      const c = comments.find(x => x.id === id);
      if (!c) return;

      // If previously disliked, undo that dislike first
      if (votes[id] === 'dislike') {
        c.dislikes = Math.max(0, c.dislikes - 1);
      }

      c.likes++;
      votes[id] = 'like';
      saveComments(comments);
      saveVotes(votes);
      renderComments();

      // Pop animation on the button
      const btn = document.querySelector(`#comment-${id} .like-active`);
      if (btn) { btn.classList.add('vote-pop'); setTimeout(() => btn.classList.remove('vote-pop'), 400); }
    }

    function handleDislike(id) {
      const votes = loadVotes();
      if (votes[id] === 'dislike') {
        showToast('You already disliked this.', 'info');
        return;
      }
      const comments = loadComments() || [];
      const idx = comments.findIndex(x => x.id === id);
      if (idx === -1) return;

      // If previously liked, undo that like first
      if (votes[id] === 'like') {
        comments[idx].likes = Math.max(0, comments[idx].likes - 1);
      }

      comments[idx].dislikes++;
      votes[id] = 'dislike';

      if (comments[idx].dislikes >= 2) {
        comments.splice(idx, 1);
        delete votes[id];
        saveComments(comments);
        saveVotes(votes);
        showToast('Comment removed after 2 dislikes', 'warn');
        renderComments();
        return;
      }
      saveComments(comments);
      saveVotes(votes);
      renderComments();

      const btn = document.querySelector(`#comment-${id} .dislike-active`);
      if (btn) { btn.classList.add('vote-pop'); setTimeout(() => btn.classList.remove('vote-pop'), 400); }
    }

    function editComment(id) {
      closeAllCommentMenus();
      const comments = loadComments() || [];
      const comment = comments.find((item) => item.id === id);
      if (!comment) return;
      if (comment.authorId && comment.authorId !== currentUserId) return;

      editingCommentId = id;
      editDraftText = comment.text;
      renderComments();
      requestAnimationFrame(() => focusInlineEditor(id));
    }

    function cancelInlineEdit() {
      editingCommentId = null;
      editDraftText = '';
      renderComments();
    }

    function saveInlineEdit(id) {
      const comments = loadComments() || [];
      const comment = comments.find((item) => item.id === id);
      if (!comment) return;
      if (comment.authorId && comment.authorId !== currentUserId) return;

      const result = validateComment(editDraftText);
      if (!result.valid) {
        showToast(result.reason === 'empty' ? 'Comment cannot be empty.' : 'Special characters are not allowed.', 'error');
        return;
      }

      comment.text = editDraftText.trim();
      comment.lang = detectLanguage(comment.text);
      comment.editedAt = Date.now();
      saveComments(comments);
      editingCommentId = null;
      editDraftText = '';
      renderComments();
      showToast('Comment updated.', 'success');
    }

    function deleteComment(id) {
      closeAllCommentMenus();
      const comments = loadComments() || [];
      const idx = comments.findIndex((item) => item.id === id && (!item.authorId || item.authorId === currentUserId));
      if (idx === -1) return;

      comments.splice(idx, 1);
      const votes = loadVotes();
      delete votes[id];
      saveComments(comments);
      saveVotes(votes);
      if (editingCommentId === id) {
        editingCommentId = null;
        editDraftText = '';
      }
      renderComments();
    }

    /** Translate using Google-first pipeline with fallbacks */
    async function performTranslation(id, originalText, sourceLang, targetLang) {
      const transBox = document.getElementById(`trans-${id}`);
      if (!transBox) return;
      const srcLang = sourceLang || detectLanguage(originalText);

      if (srcLang === targetLang) {
        showToast('Source and target language are the same.', 'info');
        return;
      }

      transBox.innerHTML = `<p class="text-[11px] text-gray-600 italic py-2">Translatingâ€¦</p>`;
      transBox.classList.remove('hidden');

      try {
        let translated = null;

        // Method 1: Google Translate public endpoint (best quality for this setup)
        try {
          if (!translated) {
            const gUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(originalText)}`;
            const gRes = await fetch(gUrl);
            if (gRes.ok) {
              const gData = await gRes.json();
              if (Array.isArray(gData) && Array.isArray(gData[0])) {
                translated = gData[0].map((row) => row[0]).join('');
              }
            }
          }
        } catch {}

        // Method 2: MyMemory with proper ISO codes
        try {
          if (!translated) {
            const mmUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalText)}&langpair=${srcLang}|${targetLang}`;
            const mmRes = await fetch(mmUrl);
            if (mmRes.ok) {
              const mmData = await mmRes.json();
              if (mmData.responseStatus === 200 && mmData.responseData?.translatedText) {
                const t = mmData.responseData.translatedText;
                if (t !== originalText.toUpperCase() && t !== originalText) {
                  translated = t;
                }
              }
            }
          }
        } catch {}

        // Method 3: Lingva fallback
        if (!translated) {
          try {
            const lvUrl = `https://lingva.ml/api/v1/${srcLang}/${targetLang}/${encodeURIComponent(originalText)}`;
            const lvRes = await fetch(lvUrl);
            if (lvRes.ok) {
              const lvData = await lvRes.json();
              if (lvData.translation) translated = lvData.translation;
            }
          } catch {}
        }

        if (!translated) throw new Error('All translation methods failed');

        transBox.innerHTML = `
          <div class="translated-box glass-subtle rounded-xl px-3 py-2.5 mt-1 space-y-1">
            <p class="text-[11px] font-medium text-gray-500">Translated to ${LANG_NAMES[targetLang] || targetLang}</p>
            <p class="text-sm text-gray-300 leading-relaxed">${escapeHTML(translated)}</p>
            <button onclick="document.getElementById('trans-${id}').classList.add('hidden')"
              class="text-[11px] text-gray-600 hover:text-gray-400 underline mt-1 transition-colors">Hide</button>
          </div>`;
      } catch {
        transBox.innerHTML = `
          <div class="glass-subtle rounded-xl px-3 py-2.5 mt-1 border border-white/[0.04]">
            <p class="text-[11px] text-gray-500">Translation unavailable right now.</p>
          </div>`;
      }
    }

    /** Post a new comment with fly animation */
    function postComment() {
      const text = $commentInput.value;
      const result = validateComment(text);
      if (!result.valid) {
        if (result.reason === 'empty') {
          showToast('Type something first.', 'warn');
        } else {
          showToast('Special characters are not allowed.', 'error');
        }
        $commentInput.focus();
        return;
      }

      const detectedLang = detectLanguage(text);
      const commentId = Date.now();
      const comment = {
        id: commentId,
        text: text.trim(),
        lang: detectedLang,
        authorId: currentUserId,
        city: userCity || 'Unknown City',
        timestamp: Date.now(),
        likes: 0,
        dislikes: 0,
      };
      const comments = loadComments() || [];
      comments.push(comment);
      saveComments(comments);

      const flyText = text.trim();
      $commentInput.value = '';

      // Trigger fly animation
      animateFlyTo(flyText, commentId);
    }

    /* =========================================================
       UTILITIES
       ========================================================= */
    function escapeHTML(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    /* =========================================================
       CITY DETECTION
       ========================================================= */
    async function detectCity() {
      if (userCity) {
        $cityText.textContent = `Posting from ${userCity}`;
        return;
      }
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        userCity = data.city || 'Unknown City';
      } catch {
        userCity = 'Unknown City';
      }
      localStorage.setItem(CITY_KEY, userCity);
      $cityText.textContent = `Posting from ${userCity}`;
    }

    /* =========================================================
       INIT
       ========================================================= */
    (function init() {
      if (!loadComments()) {
        saveComments(SEED_COMMENTS);
      }

      $langSearch.addEventListener('input', (e) => renderLanguageOptions(e.target.value));
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;

        if (!$langMenu.contains(target)) {
          closeLanguageDialog();
        }

        if (!target.closest('[id^="menu-"]') && !target.classList.contains('menu-dot')) {
          closeAllCommentMenus();
        }
      });

      window.addEventListener('scroll', () => {
        closeLanguageDialog();
        closeAllCommentMenus();
        scheduleVirtualizedRender();
      }, { passive: true });

      window.addEventListener('resize', () => {
        scheduleVirtualizedRender();
      });

      $langMenu.addEventListener('click', (e) => e.stopPropagation());
      $sendBtn.addEventListener('click', postComment);

      // Send on Enter
      $commentInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          postComment();
        }
      });

      renderComments();
      detectCity();
      setInterval(() => renderComments(), 30000);
    })();
  </script>
</body>
</html>
